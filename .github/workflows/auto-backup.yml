name: Mirror all sub-repos weekly

on:
  schedule:
    - cron: "0 2 * * 1"   # weekly Mon 02:00 UTC (10 AM SGT)
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1  # you just need the workflow files here

      - name: Mirror each sub-repo
        run: |
          mkdir mirrors
          cd mirrors
          repos=(
            "final3blindside/HE-PSMRC"
            "DhruvBDixit/Caravel-based_ReRAM-Accelerated_Safe-State_Logger_for_Edge_Devices"
            "Juan-AquinoH/secure_logger_controller"
            "ebatzolis/ReRAM-Based-Ultra-Low-Power-ECG-Anomaly-Detector-with-Patient-Adaptive-Learning"
            "mthudaa/har_reram"
            "ha-jer-9/smart_pwm"
            "partcleda/caravel_user_neuromorphic_comp"
            "Lefteris-B/ReRAM-Accelerated-Edge-Intelligence-Processor"
            "schizoneko/EDABK_SNN_CIM"
          )
          for repo in "${repos[@]}"; do
            name=$(basename "$repo")
            mirror_dir="${name}.git"
            if [ -d "$mirror_dir" ]; then
              echo "Updating mirror of $repo"
              cd "$mirror_dir"
              git remote update
              cd ..
            else
              echo "Cloning mirror of $repo"
              git clone --mirror "https://github.com/$repo.git" "$mirror_dir"
            fi
          done
          cd ..

      - name: Push mirrors to backup repo
        run: |
          # You might create a separate branch for mirrors or push into subdirectory
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add mirrors
          if git diff --cached --quiet; then
            echo "No changes to mirrors"
          else
            git commit -m "mirror backup: $(date)"
            git push
          fi
